<!DOCTYPE html>
<html class="h-full"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"/></meta><link type="text/css" rel="stylesheet" href="/assets/css/output.db2ea35b62a15e529818a8af45377626.css"/><link type="text/css" rel="stylesheet" href="/assets/css/dark.min.css"/><link rel="icon" href="/assets/images/favicon.ico"/><script defer="true" src="https://umami.bogoyavlensky.com/script.js" data-website-id="9a59a062-f94b-4564-99f8-b9445ab2525f"></script><title>End-to-end tests in Clojure with Etaoin and Testcontainers | Andrey Bogoyavlenskiy</title><meta name="author" content="Andrey Bogoyavlenskiy"/><meta name="description" content="Learn how to set up and run end-to-end tests in Clojure using Etaoin and Testcontainers, making browser testing easier without managing separate webdrivers."/><meta name="keywords" content="clojure, clj, e2e, end-to-end, testcontainers, etaoin, web, app, application, test, tests"/><link rel="canonical" href="https://bogoyavlensky.com/blog/e2e-tests-in-clojure-with-testcontainers/"/><meta property="og:site_name" content="bogoyavlensky.com"/><meta property="og:description" content="Learn how to set up and run end-to-end tests in Clojure using Etaoin and Testcontainers, making browser testing easier without managing separate webdrivers."/><meta property="og:title" content="End-to-end tests in Clojure with Etaoin and Testcontainers"/><meta property="og:url" content="https://bogoyavlensky.com/blog/e2e-tests-in-clojure-with-testcontainers/"/><meta property="og:type" content="article"/><meta property="og:image" content="https://bogoyavlensky.com/assets/images/icon.png?v=1"/><meta property="article:author" content="Andrey Bogoyavlenskiy"/><meta property="article:tag" content="clojure"/><meta property="article:tag" content="clj"/><meta property="article:tag" content="e2e"/><meta property="article:published_time" content="2025-01-25T00:00:00Z"/></head><body class="overflow-y-scroll flex flex-col h-full bg-white mx-5 md:mx-0"><div class="flex-1"><div class="max-w-3xl mx-auto"><header class="sm:flex sm:justify-between items-center h-24"><div class="flex justify-start mt-4 sm:mt-0"><a href="/" class="text-2xl font-mono font-bold text-gray-900">bogoyavlensky.com</a></div><div class="flex justify-start sm:flex-row mt-3 -ml-6 sm:ml-0"><a href="/" class="text-xl font-mono ml-6 text-gray-900 border-b-4 border-transparent border-indigo-500">blog</a><a href="/projects" class="text-xl font-mono ml-6 text-gray-900 border-b-4 border-transparent hover:border-gray-300">projects</a></div></header></div><div class="max-w-3xl mx-auto mt-10 md:mt-12"><article><div><h1 class="text-4xl md:text-5xl text-gray-900 tracking-normal leading-snug mb-1">End-to-end tests in Clojure with Etaoin and Testcontainers</h1><span class="text-sm sm:text-base mt-0 mb-4 text-gray-600">January 25, 2025</span></div><div class="prose sm:prose-lg md:prose-xl mt-6 sm:mt-10 max-w-none"><p>End-to-end (e2e) tests are a great way to ensure your application works as expected by simulating production-like conditions as closely as possible. They let you test how your application behaves from a real user&#39;s perspective.</p>
<p>In this article, we&#39;ll explore how to run end-to-end tests in Clojure using an awesome library called <a href="https://github.com/clj-commons/etaoin">Etaoin</a>. To run such tests for a web application, you typically need a webdriver to control the browser. The most common approach is running it as a separate CLI tool.</p>
<p>While this approach works, it requires having a webdriver installed on your machine. You&#39;ll need to manage versions and handle installation in CI environments. Another option is running it in a Docker container, but this still requires managing Docker images and docker-compose files.</p>
<p>This is where Testcontainers shines - it allows you to manage Docker containers directly from your code without any additional configuration or mental overhead.</p>
<h3>Simple example</h3>
<p>After evaluating several options, I settled on <a href="https://github.com/SeleniumHQ/docker-selenium">docker-selenium</a> as a webdriver in Docker. It&#39;s actively maintained and provides excellent support for running drivers on various architectures, including ARM - particularly beneficial when working with Apple Silicon processors.</p>
<p>Let&#39;s start with a basic working example in REPL using an external website. We&#39;ll test if <a href="https://clojure.org/">https://clojure.org/</a> has an <code>h2</code> title containing the text &quot;The Clojure Programming Language&quot;.</p>
<p>First, we&#39;ll need the following dependencies in our deps.edn file:</p>
<pre><code class="language-clojure">{
  ...
  :aliases 
  {:test {:extra-deps {etaoin/etaoin {:mvn/version &quot;1.1.42&quot;}
                       clj-test-containers/clj-test-containers {:mvn/version &quot;0.7.4&quot;}
                       org.testcontainers/testcontainers {:mvn/version &quot;1.20.4&quot;}}}}
  ...
}
</code></pre>
<p>Then we can start REPL, require dependencies, and run our test:</p>
<pre><code class="language-clojure">(ns demo
  (:require [clj-test-containers.core :as tc]
            [etaoin.api :as etaoin]))

(let [webdriver-port 4444
      container (-&gt; (tc/create {:image-name &quot;selenium/standalone-chromium:131.0&quot;
                                :exposed-ports [webdriver-port]})
                    (tc/start!))
      driver (etaoin/chrome-headless {:port (get (:mapped-ports container) webdriver-port)
                                      :host (:host container)
                                      :args [&quot;--no-sandbox&quot;]})]

  (etaoin/go driver &quot;https://clojure.org&quot;)
  (etaoin/visible? driver {:tag :h2
                           :fn/has-text &quot;The Clojure Programming Language&quot;}))  
</code></pre>
<p>The last expression should return <code>true</code>. In this example, we first create a container using the <code>clj-test-containers</code> library (a convenient wrapper for the Testcontainers library). Then we initialize a driver that we&#39;ll use to load the web page and verify the title content.</p>
<h3>Test local server</h3>
<p>In real-world scenarios, we often need to test against a local development server. When the webdriver runs in a Docker container, we need to expose the local port from the host machine to the Docker container. For this, we use the <code>exposeHostPorts</code> function from Testcontainers. This should be called after starting the server but before running the test. To access this server from within the testcontainer, instead of <code>localhost</code> we use <code>http://host.testcontainers.internal</code> with the appropriate port.</p>
<p>Let&#39;s create a Jetty server on port <code>8000</code> and verify if the <code>h2</code> title contains the text &quot;The Clojure Programming Language&quot;. We&#39;ll need these additional dependencies:</p>
<pre><code>compojure/compojure {:mvn/version &quot;1.7.1&quot;}
ring/ring-jetty-adapter {:mvn/version &quot;1.13.0&quot;}
</code></pre>
<p>Let&#39;s modify our previous example by adding our own local server:</p>
<pre><code class="language-diff">  (ns demo
    (:require [clj-test-containers.core :as tc]
              [etaoin.api :as etaoin]
+             [compojure.core :as compojure]
+             [ring.adapter.jetty :as jetty])
+   (:import [org.testcontainers Testcontainers]))

+ (compojure/defroutes app
+   (compojure/GET &quot;/&quot; [] &quot;&lt;h2&gt;The Clojure Programming Language&lt;/h2&gt;&quot;))

+ (jetty/run-jetty app {:port 8000 :join? false})

; Expose local port into Docker container 
+ (Testcontainers/exposeHostPorts (int-array [8000]))

  (let [webdriver-port 4444
        container (-&gt; (tc/create {:image-name &quot;selenium/standalone-chromium:131.0&quot;
                                  :exposed-ports [webdriver-port]})
                      (tc/start!))
        driver (etaoin/chrome-headless {:port (get (:mapped-ports container) webdriver-port)
                                        :host (:host container)
                                        :args [&quot;--no-sandbox&quot;]})]

-   (etaoin/go driver &quot;https://clojure.org&quot;)  
+   (etaoin/go driver &quot;http://host.testcontainers.internal:8000&quot;)
    (etaoin/visible? driver {:tag :h2
                             :fn/has-text &quot;The Clojure Programming Language&quot;}))
</code></pre>
<p>Running this snippet should return <code>true</code>. We&#39;ve successfully set up a server on port <code>8000</code> and exposed it to the Docker container, enabling us to test our local web page inside the testcontainer.</p>
<p>That covers the basics! You can now run tests against your local server using webdriver with Testcontainers. As a bonus, let&#39;s explore how to integrate this approach with an application system.</p>
<h3>Integrate with application system</h3>
<p>In a real-world application, you&#39;ll likely use a component system to manage your application&#39;s lifecycle. Let&#39;s see how to integrate this approach with <a href="https://github.com/weavejester/integrant">Integrant</a>.</p>
<p>First, we&#39;ll need one more dependency:</p>
<pre><code class="language-clojure">integrant/integrant {:mvn/version &quot;0.13.1&quot;}
</code></pre>
<p>Let&#39;s configure our system:</p>
<p><em>resources/config.end</em></p>
<pre><code class="language-clojure">{:app.server/server {}
 :app.server/webdriver {:server #ig/ref :app.server/server}}
</code></pre>
<p>Then create a component for the server:</p>
<p><em>src/app/server.clj</em></p>
<pre><code class="language-clojure">(ns app.server
  (:require [compojure.core :as compojure]
            [ring.adapter.jetty :as jetty]
            [integrant.core :as ig])

(compojure/defroutes app
  (compojure/GET &quot;/&quot; [] &quot;&lt;h2&gt;The Clojure Programming Language&lt;/h2&gt;&quot;))

(defmethod ig/init-key ::server
  [_ _]
  (jetty/run-jetty app {:port 8000 :join? false}))

(defmethod ig/halt-key! ::server
  [_ server]
  (.stop server))
</code></pre>
<p>And a component for webdriver that we can enable just in test system:</p>
<p><em>test/app/webdriver.clj</em></p>
<pre><code class="language-clojure">(ns app.webdriver
  (:require [clj-test-containers.core :as tc]
            [etaoin.api :as etaoin]
            [compojure.core :as compojure]
            [ring.adapter.jetty :as jetty]
            [integrant.core :as ig])
  (:import [org.testcontainers Testcontainers]))

(defmethod ig/init-key ::webdriver
  [_ {:keys [server]}]
  (let [webdriver-port 4444
        server-port (.getLocalPort (first (.getConnectors server)))
        ; Expose port from local machine to container
        _ (Testcontainers/exposeHostPorts (int-array [server-port]))
        container (-&gt; (tc/create {:image-name &quot;selenium/standalone-chromium:131.0&quot;
                                  :exposed-ports [webdriver-port]})
                      (update :container #(.withReuse % true))
                      (tc/start!))]

    {:container container
     :driver (etaoin/chrome-headless {:port (get (:mapped-ports container) webdriver-port)
                                      :host (:host container)
                                      :args [&quot;--no-sandbox&quot;]})}))

(defmethod ig/halt-key! ::webdriver
  [_ {:keys [driver]}]
  (log/info (str &quot;[DB] Closing webdriver...&quot;))
  ; Do not stop the container to be able to reuse it
  (etaoin/quit driver))
</code></pre>
<p>Now in your <code>deftest</code>, you can access the <code>driver</code> from the <code>webdriver</code> component of the test system to run your assertions using Etaoin.</p>
<p>By setting <code>.withReuse</code> to <code>true</code> and enabling the <code>TESTCONTAINERS_REUSE_ENABLE=true</code> environment variable, you can reuse containers between tests.
This is why we don&#39;t stop the container in the <code>halt-key!</code> method. Container reuse significantly reduces test execution time during local development since you don&#39;t have to wait for container startup between test runs.
In a CI environment, we omit the <code>TESTCONTAINERS_REUSE_ENABLE</code> variable to disable reuse. The JVM process automatically stops all containers when it terminates, so explicit cleanup in <code>halt-key!</code> isn&#39;t necessary.</p>
<h3>Wrapping up</h3>
<p>In this article, we&#39;ve explored how to set up end-to-end tests in Clojure using Etaoin and Testcontainers. We started with a simple example, progressed to testing a local server, and finally integrated the solution with a component system using Integrant. This approach eliminates the hassle of managing separate webdrivers and Docker configurations, making e2e testing more straightforward and maintainable.</p>

</div></article></div></div><footer><div class="max-w-3xl mx-auto flex justify-between items-center h-24 border-t border-gray-300 mt-32"><div class="text-sm sm:text-base">© Andrey Bogoyavlenskiy | Since 2020</div><div class="flex flex-row"><a href="https://github.com/abogoyavlensky" target="_blank" class="p-2 hover:bg-gray-200 rounded-full ml-2"><svg stroke="#1a202c" fill="none" stroke-linejoin="round" width="32" xmlns="http://www.w3.org/2000/svg" stroke-linecap="round" stroke-width="1" viewBox="0 0 24 24" height="32"><path stroke="none" d="M0 0h24v24H0z"></path><path d="M9 19c-4.286 1.35-4.286-2.55-6-3m12 5v-3.5c0-1 .099-1.405-.5-2 2.791-.3 5.5-1.366
                 5.5-6.04a4.567 4.567 0 0 0 -1.333 -3.21 4.192 4.192 0 00-.08-3.227s-1.05-.3-3.476
                 1.267a12.334 12.334 0 0 0 -6.222 0C6.462 2.723 5.413 3.023 5.413 3.023a4.192 4.192
                 0 0 0 -.08 3.227A4.566 4.566 0 004 9.486c0 4.64 2.709 5.68 5.5 6.014-.591.589-.56 1.183-.5 2V21"></path></svg></a><a href="https://twitter.com/abogoyavlensky" target="_blank" class="p-2 hover:bg-gray-200 rounded-full ml-2"><svg stroke="#1a202c" fill="none" stroke-linejoin="round" width="32" xmlns="http://www.w3.org/2000/svg" stroke-linecap="round" stroke-width="1" viewBox="0 0 24 24" height="32"><path stroke="none" d="M0 0h24v24H0z"></path><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12
                  8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308
                  1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84 0 0 0 .497
                  -3.753C20.18 7.773 21.692 5.25 22 4.009z"></path></svg></a><a href="/feed.xml" target="_blank" class="p-2 hover:bg-gray-200 rounded-full ml-2"><svg stroke="#1a202c" fill="none" stroke-linejoin="round" width="32" xmlns="http://www.w3.org/2000/svg" stroke-linecap="round" stroke-width="1" viewBox="0 0 24 24" height="32"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="5" cy="19" r="1"></circle><path d="M4 4a16 16 0 0 1 16 16"></path><path d="M4 11a9 9 0 0 1 9 9"></path></svg></a></div></div></footer><script src="/assets/js/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></body></html>